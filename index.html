<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Projektmaßstab & Höhenreduktion</title>
  <!-- proj4js für UTM->WGS84 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:800px; margin:auto; padding:2rem; background:#f9f9f9; color:#333; }
    h1,h2 { color:#003f6b; border-bottom:2px solid #ccc; padding-bottom:.3rem; }
    label { display:block; margin-top:1rem; font-weight:bold; }
    input, select, button { width:100%; padding:.5rem; margin-top:.2rem; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; }
    .btn-group { display:flex; gap:1rem; margin-top:1.5rem; }
    .btn-group button { flex:1; background:#005288; color:#fff; border:none; cursor:pointer; transition:background .2s; }
    .btn-group button:hover { background:#003f6b; }
    .output { background:#eef3f7; border:1px solid #cdd6e0; margin-top:2rem; padding:1.5rem; border-radius:8px; }
    code { background:#e0e7ef; padding:2px 6px; border-radius:3px; font-family:monospace; }
  </style>
</head>
<body>
  <h1>Projektmaßstab & Höhenreduktion</h1>

  <h2>Eingaben</h2>
  <label>x (Rechtswert, m):<input id="x" type="number"></label>
  <label>y (Hochwert, m):<input id="y" type="number"></label>
  <label><input id="autoHoehe" type="checkbox" checked> Höhe automatisch aus DGM</label>
  <label>Höhe NHN (m):<input id="hoehe" type="number"></label>
  <label>Zone:<select id="zone"><option>32</option><option>33</option></select></label>
  <label>Rm (km):<select id="radius_option"><option value="6382">Statisch 6382</option><option value="dynamic">Dynamisch</option></select></label>

  <div class="btn-group">
    <button onclick="berechneMassstab()">Berechnen</button>
  </div>

  <div class="output" id="ergebnis">Lade Daten…</div>

  <script>
    // DGM aus GitHub-Pages (dgm.txt im selben Verzeichnis)
    const dgmUrl = 'dgm.txt';
    // Geoid per Google Drive + CORS-Proxy
    const geoidUrl = 'https://api.allorigins.win/raw?url=' +
      encodeURIComponent('https://drive.google.com/uc?export=download&id=133YvzhAMvY6YBGcmcobptCaxMPpr5C6K');

    let dgmGrid = [], geoidGrid = [];

    window.onload = async () => {
      // DGM laden
      try {
        const dgmText = await (await fetch(dgmUrl)).text();
        dgmText.trim().split(/\r?\n/).forEach(line => {
          const [x,y,h] = line.trim().split(/\s+/).map(Number);
          if (!isNaN(x) && !isNaN(y) && !isNaN(h)) dgmGrid.push({x,y,h});
        });
        console.log('DGM geladen:', dgmGrid.length);
      } catch (e) {
        console.warn('Fehler Laden dgm.txt:', e);
      }
      // Geoid laden
      try {
        const geoidText = await (await fetch(geoidUrl)).text();
        geoidText.trim().split(/\r?\n/).forEach(line => {
          const [lat,lon,und] = line.trim().split(/\s+/).map(Number);
          if (!isNaN(lat) && !isNaN(lon) && !isNaN(und)) geoidGrid.push({lat,lon,und});
        });
        console.log('Geoid geladen:', geoidGrid.length);
      } catch (e) {
        console.warn('Fehler Laden Geoid:', e);
      }
      document.getElementById('ergebnis').innerText = 'Daten geladen. Bitte Eingaben.';
    };

    function berechneMassstab() {
      const x = parseFloat(document.getElementById('x').value);
      const y = parseFloat(document.getElementById('y').value);
      const auto = document.getElementById('autoHoehe').checked;
      let hoehe = parseFloat(document.getElementById('hoehe').value);
      const zone = parseInt(document.getElementById('zone').value);
      if (isNaN(x) || isNaN(y) || (!auto && isNaN(hoehe))) {
        return alert('Bitte x, y und Höhe eingeben.');
      }
      // Automatische DGM-Höhe
      if (auto && dgmGrid.length) {
        let nearest, md = Infinity;
        dgmGrid.forEach(p => {
          const d = (p.x - x) ** 2 + (p.y - y) ** 2;
          if (d < md) { md = d; nearest = p; }
        });
        if (nearest) hoehe = nearest.h;
      }
      document.getElementById('hoehe').value = hoehe.toFixed(2);

      // UTM -> WGS84 für Geoid
      const projStr = `+proj=utm +zone=${zone} +datum=WGS84 +units=m +no_defs`;
      const [lon, lat] = proj4(projStr, 'WGS84', [x, y]);

      // Geoid-Undulation
      let und = 47;
      if (geoidGrid.length) {
        let nearest, md = Infinity;
        geoidGrid.forEach(p => {
          const d = (p.lat - lat) ** 2 + (p.lon - lon) ** 2;
          if (d < md) { md = d; nearest = p; }
        });
        if (nearest && nearest.und < 1e4) und = nearest.und;
      }

      const Rm = document.getElementById('radius_option').value === 'dynamic'
        ? 6371000 + (zone - 31) * 1000
        : 6382000;
      const H_ell = hoehe + und;
      const m = 0.9996 * (1 - (H_ell / Rm) + ((x / 1000 - 500) ** 2) / (2 * 6382 ** 2));
      const ppm = (m - 1) * 1e6;
      const inv = 1 / m;

      document.getElementById('ergebnis').innerHTML = `
        <strong>H_NHN:</strong> ${hoehe.toFixed(2)} m<br>
        <strong>Undulation:</strong> ${und.toFixed(2)} m<br>
        <strong>H_ell:</strong> ${H_ell.toFixed(3)} m<br>
        <strong>m:</strong> <code>${m.toFixed(10)}</code><br>
        <strong>ppm:</strong> <code>${ppm.toFixed(2)}</code><br>
        <strong>1/m:</strong> <code>${inv.toFixed(10)}</code>
      `;
    }
  </script>
</body>
</html>

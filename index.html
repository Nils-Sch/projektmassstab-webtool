<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Projektmaßstab & Höhenreduktion ETRS89-UTM</title>
  <!-- proj4js für UTM->WGS84 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.min.js"></script>
  <!-- jsPDF für PDF-Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:900px; margin:auto; padding:2rem; background:#f9f9f9; color:#333; }
    h1 { color:#005288; }
    fieldset { border:1px solid #ccc; padding:1rem; margin-bottom:1rem; border-radius:5px; }
    legend { font-weight:bold; }
    label { display:block; margin-top:0.5rem; }
    input, select { width:100%; padding:0.5rem; margin-top:0.2rem; box-sizing:border-box; }
    .btn-group { display:flex; gap:1rem; margin-top:1rem; }
    button { flex:1; padding:0.7rem; background:#005288; color:#fff; border:none; cursor:pointer; border-radius:4px; }
    button:hover { background:#003f6b; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th, td { border:1px solid #ccc; padding:0.5rem; text-align:left; }
    th { background:#eef3f7; }
    .error { color:red; }
  </style>
</head>
<body>
  <h1>Projektmaßstab & Höhenreduktion ETRS89-UTM</h1>
  <form id="form">
    <fieldset>
      <legend>Projektinformationen</legend>
      <label>1. Projekt / Liegenschaft:<input type="text" id="projekt"></label>
      <label>2. ID:<input type="text" id="projekt_id"></label>
      <label>3. Sachbearbeiter:<input type="text" id="sachbearbeiter"></label>
      <label>4. Datum:<input type="date" id="datum"></label>
    </fieldset>

    <fieldset>
      <legend>Grunddaten</legend>
      <label>5. UTM-Zone:<select id="zone"><option>32</option><option>33</option></select></label>
      <label>6. Rechtswert (6-stellig):<input type="text" id="x" maxlength="6"></label>
      <label>7. Hochwert (7-stellig):<input type="text" id="y" maxlength="7"></label>
      <span id="coordError" class="error"></span>

      <label>8. Höhe NHN 2016 (m):<input type="number" id="hoehe"><br>
        <small>Wird automatisch aus DGM (1000 m Raster) berechnet; kann ungenau sein.</small>
      </label>

      <label>8.1 Krümmungsradius R<sub>m</sub> (km):<select id="radius_option"><option value="6382">6382</option><option value="dynamic">Berechnen</option></select></label>

      <label>9. Undulation (m):<input type="number" id="undulation"><br>
        <small>Wird automatisch aus Geoid-Modell berechnet.</small>
      </label>

      <label>10. Projektausdehnung (m):<input type="number" id="extent"></label>
      <small id="extentWarn" class="error"></small>
    </fieldset>

    <div class="btn-group">
      <button type="button" onclick="berechne()">Berechnen</button>
      <button type="button" onclick="exportPDF()">PDF-Protokoll</button>
      <button type="button" onclick="exportCSV()">CSV-Export</button>
    </div>
  </form>

  <div id="ergebnis"></div>

<script>
  const dgmUrl = 'dgm.txt';
  const geoidUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://drive.google.com/uc?export=download&id=133YvzhAMvY6YBGcmcobptCaxMPpr5C6K');
  let dgmGrid = [], geoidGrid = [];

  window.onload = async () => {
    document.getElementById('datum').value = new Date().toISOString().substr(0,10);
    try { const text = await fetch(dgmUrl).then(r=>r.text()); text.trim().split(/\r?\n/).forEach(l=>{const [x,y,h]=l.split(/\s+/).map(Number); if(!isNaN(x)&&!isNaN(y)&&!isNaN(h)) dgmGrid.push({x,y,h}); }); } catch{};
    try { const text = await fetch(geoidUrl).then(r=>r.text()); text.trim().split(/\r?\n/).forEach(l=>{const [lat,lon,und]=l.split(/\s+/).map(Number); if(!isNaN(lat)&&!isNaN(lon)&&!isNaN(und)) geoidGrid.push({lat,lon,und}); }); } catch{};
  };

  function warn(msg,id){document.getElementById(id).innerText=msg;}

  function berechne(){
    const x=document.getElementById('x').value, y=document.getElementById('y').value;
    let valid=true; if(!/^\d{6}$/.test(x)||!/^\d{7}$/.test(y)){warn('Rechtswert 6 und Hochwert 7 Ziffern erforderlich.','coordError'); valid=false;} else warn('','coordError');
    const extent=+document.getElementById('extent').value; if(extent>5000) warn('Projekt >5000m!','extentWarn'); else warn('','extentWarn');
    if(!valid) return;
    let hoehe=+document.getElementById('hoehe').value;
    if(document.getElementById('autoHoehe').checked && dgmGrid.length){let n,md=Infinity; dgmGrid.forEach(p=>{const d=(p.x+''===x?0:(p.x-x)**2)+(p.y+''===y?0:(p.y-y)**2); if(d<md){md=d;n=p;}}); if(n) hoehe=n.h;} document.getElementById('hoehe').value=hoehe.toFixed(2);
    const zone=+document.getElementById('zone').value;
    const [lon,lat]=proj4(`+proj=utm +zone=${zone} +datum=WGS84 +units=m +no_defs`,'WGS84',[+x,+y]);
    let und=47; if(geoidGrid.length){let n,md=Infinity; geoidGrid.forEach(p=>{const d=(p.lat-lat)**2+(p.lon-lon)**2; if(d<md){md=d;n=p;}}); if(n&&n.und<1e4)und=n.und;} document.getElementById('undulation').value=und.toFixed(2);
    let Rm = +document.getElementById('radius_option').value*1000; if(document.getElementById('radius_option').value==='dynamic') Rm=6371000+(zone-31)*1000;
    const Hell=hoehe+und;
    const m_h=1-Hell/Rm;
    const m_proj=0.9996*(1+((+x/1000-500)**2)/(2*6382**2));
    const m=0.9996*(m_h+((+x/1000-500)**2)/(2*6382**2));
    const ppm=(m-1)*1e6;
    const inv=1/m;
    let html='<h2>Ergebnisse</h2><table><tr><th>Feld</th><th>Wert</th></tr>' +
      `<tr><td>Geogr. Breite</td><td>${lat.toFixed(8)}</td></tr><tr><td>Geogr. Länge</td><td>${lon.toFixed(8)}</td></tr>`+
      `<tr><td>Ellipsoidische Höhe</td><td>${Hell.toFixed(3)}</td></tr><tr><td>Rm (m)</td><td>${Rm.toFixed(0)}</td></tr>`+
      `<tr><td>Höhenmaßstab</td><td>${m_h.toFixed(6)} (${((m_h-1)*100).toFixed(2)} cm/100m)</td></tr>`+
      `<tr><td>Projektionsmaßstab</td><td>${m_proj.toFixed(6)} (${((m_proj-1)*100).toFixed(2)} cm/100m)</td></tr>`+
      `<tr><td>Projektmaßstab</td><td>${m.toFixed(6)} (${((m-1)*100).toFixed(2)} cm/100m)</td></tr>`+
      `<tr><td>Streckenverzerrung (ppm)</td><td>${ppm.toFixed(1)}</td></tr>`+
      `<tr><td>Maßstabanpassung</td><td>${inv.toFixed(8)} (${((inv-1)*100).toFixed(2)} cm/100m)</td></tr>`;
    html+='</table>'; document.getElementById('ergebnis').innerHTML=html;
  }

  function exportPDF(){/*...*/}
  function exportCSV(){/*...*/}
</script>
</body>
</html>
